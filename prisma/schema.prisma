// Authentication schema for Next.js boilerplate
// Local PostgreSQL 15 + pgvector
// Run once: CREATE EXTENSION IF NOT EXISTS vector;

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model: core authentication identity
model User {
  id                     String    @id @default(cuid())
  email                  String    @unique @db.VarChar(255)
  name                   String?   @db.VarChar(255)
  passwordHash           String?   @db.VarChar(255)
  emailVerifiedAt        DateTime?
  role                   String    @default("user") @db.VarChar(50)
  sessionVersion         Int       @default(1)
  defaultOrganizationId  String?
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt

  auditLogs              AuditLog[]
  memberships            Membership[]
  createdOrganizations   Organization[] @relation("OrganizationCreator")
  sentInvitations        Invitation[]   @relation("InvitationSender")
  defaultOrganization    Organization?  @relation("UserDefaultOrganization", fields: [defaultOrganizationId], references: [id], onDelete: SetNull)
  createdAiKeys          OrganizationAiApiKey[] @relation("AiKeyCreatedBy")
  updatedAiKeys          OrganizationAiApiKey[] @relation("AiKeyUpdatedBy")
  aiGenerationLogs       AiGenerationLog[] @relation("AiGenerationLogs")

  @@index([email])
  @@index([defaultOrganizationId])
  @@map("users")
}

// OTP token storage: bcrypt-hashed codes
model OtpToken {
  id         String    @id @default(cuid())
  email      String    @db.VarChar(255)
  otpHash    String    @db.VarChar(255)
  expiresAt  DateTime
  consumedAt DateTime?
  attempts   Int       @default(0)
  createdAt  DateTime  @default(now())

  @@index([email, expiresAt])
  @@index([email, consumedAt])
  @@map("otp_tokens")
}

// Rate limiting: tracks OTP requests per email/IP
model OtpRequest {
  id          String   @id @default(cuid())
  email       String   @db.VarChar(255)
  ip          String?  @db.VarChar(100)
  requestedAt DateTime @default(now())

  @@index([email, requestedAt])
  @@index([ip, requestedAt])
  @@map("otp_requests")
}

// Audit log: track authentication and security events
model AuditLog {
  id             String   @id @default(cuid())
  action         String   @db.VarChar(100)
  userId         String?
  email          String?  @db.VarChar(255)
  ip             String?  @db.VarChar(100)
  organizationId String?
  metadata       Json?
  createdAt      DateTime @default(now())

  user         User?         @relation(fields: [userId], references: [id], onDelete: SetNull)
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)

  @@index([action, createdAt])
  @@index([userId, createdAt])
  @@index([email, createdAt])
  @@index([organizationId, createdAt])
  @@map("audit_logs")
}

// Organization: tenant isolation boundary
model Organization {
  id          String   @id @default(cuid())
  name        String   @db.VarChar(255)
  slug        String   @unique @db.VarChar(50)
  createdById String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  createdBy             User                     @relation("OrganizationCreator", fields: [createdById], references: [id], onDelete: Restrict)
  memberships           Membership[]
  invitations           Invitation[]
  auditLogs             AuditLog[]
  defaultForUsers       User[]                   @relation("UserDefaultOrganization")
  aiApiKeys             OrganizationAiApiKey[]
  aiModels              OrganizationAiModel[]
  aiGenerationLogs      AiGenerationLog[]
  aiSettings            OrganizationAiSettings?

  @@index([slug])
  @@index([createdById])
  @@map("organizations")
}

// Membership: user-organization relationship with role
model Membership {
  id             String   @id @default(cuid())
  userId         String
  organizationId String
  role           String   @db.VarChar(20) // "admin" | "member"
  createdAt      DateTime @default(now())

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId])
  @@index([userId])
  @@index([organizationId, createdAt])
  @@map("memberships")
}

// Invitation: pending org membership invitations
model Invitation {
  id             String    @id @default(cuid())
  organizationId String
  email          String    @db.VarChar(255)
  name           String?   @db.VarChar(255)
  role           String    @db.VarChar(20) // "admin" | "member"
  tokenHash      String    @db.VarChar(255)
  expiresAt      DateTime
  invitedById    String
  acceptedAt     DateTime?
  revokedAt      DateTime?
  createdAt      DateTime  @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  invitedBy    User         @relation("InvitationSender", fields: [invitedById], references: [id], onDelete: Restrict)

  @@index([organizationId, email])
  @@index([tokenHash])
  @@index([email, acceptedAt, revokedAt])
  @@map("invitations")
}

// OrganizationAiApiKey: encrypted API keys per provider
model OrganizationAiApiKey {
  id               String   @id @default(cuid())
  organizationId   String
  provider         String   @db.VarChar(20) // "openai" | "gemini" | "anthropic"
  encryptedKey     String   @db.Text // AES-256-GCM envelope, base64-encoded
  lastFour         String   @db.VarChar(4) // Last 4 chars for display
  lastVerifiedAt   DateTime
  createdByUserId  String
  updatedByUserId  String
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  organization  Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdBy     User                  @relation("AiKeyCreatedBy", fields: [createdByUserId], references: [id], onDelete: Restrict)
  updatedBy     User                  @relation("AiKeyUpdatedBy", fields: [updatedByUserId], references: [id], onDelete: Restrict)
  models        OrganizationAiModel[]

  @@unique([organizationId, provider])
  @@index([organizationId, provider])
  @@index([organizationId, updatedAt])
  @@map("organization_ai_api_keys")
}

// OrganizationAiModel: curated models per organization/provider
model OrganizationAiModel {
  id               String   @id @default(cuid())
  organizationId   String
  provider         String   @db.VarChar(20) // "openai" | "gemini" | "anthropic"
  name             String   @db.VarChar(100) // e.g., "gpt-4o-mini"
  label            String   @db.VarChar(100) // Display label
  maxOutputTokens  Int
  isDefault        Boolean  @default(false)
  apiKeyId         String
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  organization Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  apiKey       OrganizationAiApiKey @relation(fields: [apiKeyId], references: [id], onDelete: Cascade)

  @@unique([organizationId, provider, name])
  @@index([organizationId, provider])
  @@index([organizationId, isDefault])
  @@map("organization_ai_models")
}

// AiGenerationLog: usage logs with tokens, latency, correlation IDs
model AiGenerationLog {
  id                   String    @id @default(cuid())
  organizationId       String
  userId               String
  provider             String    @db.VarChar(20)
  model                String    @db.VarChar(100)
  feature              String    @db.VarChar(50) // e.g., "generic-text"
  status               String    @db.VarChar(20) // "ok" | "error" | "canceled"
  tokensIn             Int?
  tokensOut            Int?
  latencyMs            Int
  correlationId        String    @db.VarChar(100)
  rawInputTruncated    String    @db.Text // Sanitized + truncated
  rawOutputTruncated   String    @db.Text // Sanitized + truncated
  rawRequest           Json?     @db.Json // Sanitized Vercel AI SDK request params
  rawResponse          Json?     @db.Json // Sanitized Vercel AI SDK result object
  errorCode            String?   @db.VarChar(100)
  errorMessage         String?   @db.Text
  createdAt            DateTime  @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation("AiGenerationLogs", fields: [userId], references: [id], onDelete: Cascade)

  @@index([organizationId, createdAt])
  @@index([organizationId, provider, model, createdAt])
  @@index([organizationId, correlationId])
  @@map("ai_generation_logs")
}

// OrganizationAiSettings: retention and rate limit overrides
model OrganizationAiSettings {
  id               String   @id @default(cuid())
  organizationId   String   @unique
  retentionDays    Int      @default(30)
  perMinuteLimit   Int? // Nullable; override env
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("organization_ai_settings")
}
