// Authentication schema for Next.js boilerplate
// Local PostgreSQL 15 + pgvector
// Run once: CREATE EXTENSION IF NOT EXISTS vector;

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model: core authentication identity
model User {
  id                     String    @id @default(cuid())
  email                  String    @unique @db.VarChar(255)
  name                   String?   @db.VarChar(255)
  passwordHash           String?   @db.VarChar(255)
  emailVerifiedAt        DateTime?
  role                   String    @default("user") @db.VarChar(50)
  sessionVersion         Int       @default(1)
  defaultOrganizationId  String?
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt

  auditLogs              AuditLog[]
  memberships            Membership[]
  createdOrganizations   Organization[] @relation("OrganizationCreator")
  sentInvitations        Invitation[]   @relation("InvitationSender")
  defaultOrganization    Organization?  @relation("UserDefaultOrganization", fields: [defaultOrganizationId], references: [id], onDelete: SetNull)
  createdAiKeys          OrganizationAiApiKey[] @relation("AiKeyCreatedBy")
  updatedAiKeys          OrganizationAiApiKey[] @relation("AiKeyUpdatedBy")
  aiGenerationLogs       AiGenerationLog[] @relation("AiGenerationLogs")
  createdIntegrations    OrganizationIntegration[] @relation("IntegrationCreatedBy")
  updatedIntegrations    OrganizationIntegration[] @relation("IntegrationUpdatedBy")
  transactions           Transaction[] @relation("TransactionCreator")

  @@index([email])
  @@index([defaultOrganizationId])
  @@map("users")
}

// OTP token storage: bcrypt-hashed codes
model OtpToken {
  id         String    @id @default(cuid())
  email      String    @db.VarChar(255)
  otpHash    String    @db.VarChar(255)
  expiresAt  DateTime
  consumedAt DateTime?
  attempts   Int       @default(0)
  createdAt  DateTime  @default(now())

  @@index([email, expiresAt])
  @@index([email, consumedAt])
  @@map("otp_tokens")
}

// Rate limiting: tracks OTP requests per email/IP
model OtpRequest {
  id          String   @id @default(cuid())
  email       String   @db.VarChar(255)
  ip          String?  @db.VarChar(100)
  requestedAt DateTime @default(now())

  @@index([email, requestedAt])
  @@index([ip, requestedAt])
  @@map("otp_requests")
}

// Audit log: track authentication and security events
model AuditLog {
  id             String   @id @default(cuid())
  action         String   @db.VarChar(100)
  userId         String?
  email          String?  @db.VarChar(255)
  ip             String?  @db.VarChar(100)
  organizationId String?
  metadata       Json?
  createdAt      DateTime @default(now())

  user         User?         @relation(fields: [userId], references: [id], onDelete: SetNull)
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)

  @@index([action, createdAt])
  @@index([userId, createdAt])
  @@index([email, createdAt])
  @@index([organizationId, createdAt])
  @@map("audit_logs")
}

// Organization: tenant isolation boundary
model Organization {
  id                   String   @id @default(cuid())
  name                 String   @db.VarChar(255)
  slug                 String   @unique @db.VarChar(50)
  createdById          String
  onboardingComplete   Boolean  @default(false)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  createdBy             User                        @relation("OrganizationCreator", fields: [createdById], references: [id], onDelete: Restrict)
  memberships           Membership[]
  invitations           Invitation[]
  auditLogs             AuditLog[]
  defaultForUsers       User[]                      @relation("UserDefaultOrganization")
  aiApiKeys             OrganizationAiApiKey[]
  aiModels              OrganizationAiModel[]
  aiGenerationLogs      AiGenerationLog[]
  aiSettings            OrganizationAiSettings?
  integrations          OrganizationIntegration[]
  settings              OrganizationSettings?
  accounts              Account[]
  categories            Category[]
  vendors               Vendor[]
  clients               Client[]
  transactions          Transaction[]

  @@index([slug])
  @@index([createdById])
  @@map("organizations")
}

// Membership: user-organization relationship with role
model Membership {
  id               String   @id @default(cuid())
  userId           String
  organizationId   String
  role             String   @db.VarChar(20) // "admin" | "member"
  dashboardLayout  Json?    // User's dashboard widget layout preferences
  createdAt        DateTime @default(now())

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId])
  @@index([userId])
  @@index([organizationId, createdAt])
  @@map("memberships")
}

// Invitation: pending org membership invitations
model Invitation {
  id             String    @id @default(cuid())
  organizationId String
  email          String    @db.VarChar(255)
  name           String?   @db.VarChar(255)
  role           String    @db.VarChar(20) // "admin" | "member"
  tokenHash      String    @db.VarChar(255)
  expiresAt      DateTime
  invitedById    String
  acceptedAt     DateTime?
  revokedAt      DateTime?
  createdAt      DateTime  @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  invitedBy    User         @relation("InvitationSender", fields: [invitedById], references: [id], onDelete: Restrict)

  @@index([organizationId, email])
  @@index([tokenHash])
  @@index([email, acceptedAt, revokedAt])
  @@map("invitations")
}

// OrganizationAiApiKey: encrypted API keys per provider
model OrganizationAiApiKey {
  id               String   @id @default(cuid())
  organizationId   String
  provider         String   @db.VarChar(20) // "openai" | "gemini" | "anthropic"
  encryptedKey     String   @db.Text // AES-256-GCM envelope, base64-encoded
  lastFour         String   @db.VarChar(4) // Last 4 chars for display
  lastVerifiedAt   DateTime
  createdByUserId  String
  updatedByUserId  String
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  organization  Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdBy     User                  @relation("AiKeyCreatedBy", fields: [createdByUserId], references: [id], onDelete: Restrict)
  updatedBy     User                  @relation("AiKeyUpdatedBy", fields: [updatedByUserId], references: [id], onDelete: Restrict)
  models        OrganizationAiModel[]

  @@unique([organizationId, provider])
  @@index([organizationId, provider])
  @@index([organizationId, updatedAt])
  @@map("organization_ai_api_keys")
}

// OrganizationAiModel: curated models per organization/provider
model OrganizationAiModel {
  id               String   @id @default(cuid())
  organizationId   String
  provider         String   @db.VarChar(20) // "openai" | "gemini" | "anthropic"
  name             String   @db.VarChar(100) // e.g., "gpt-4o-mini"
  label            String   @db.VarChar(100) // Display label
  maxOutputTokens  Int
  isDefault        Boolean  @default(false)
  apiKeyId         String
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  organization Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  apiKey       OrganizationAiApiKey @relation(fields: [apiKeyId], references: [id], onDelete: Cascade)

  @@unique([organizationId, provider, name])
  @@index([organizationId, provider])
  @@index([organizationId, isDefault])
  @@map("organization_ai_models")
}

// AiGenerationLog: usage logs with tokens, latency, correlation IDs
model AiGenerationLog {
  id                   String    @id @default(cuid())
  organizationId       String
  userId               String
  provider             String    @db.VarChar(20)
  model                String    @db.VarChar(100)
  feature              String    @db.VarChar(50) // e.g., "generic-text"
  status               String    @db.VarChar(20) // "ok" | "error" | "canceled"
  tokensIn             Int?
  tokensOut            Int?
  latencyMs            Int
  correlationId        String    @db.VarChar(100)
  rawInputTruncated    String    @db.Text // Sanitized + truncated
  rawOutputTruncated   String    @db.Text // Sanitized + truncated
  rawRequest           Json?     @db.Json // Sanitized Vercel AI SDK request params
  rawResponse          Json?     @db.Json // Sanitized Vercel AI SDK result object
  errorCode            String?   @db.VarChar(100)
  errorMessage         String?   @db.Text
  createdAt            DateTime  @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation("AiGenerationLogs", fields: [userId], references: [id], onDelete: Cascade)

  @@index([organizationId, createdAt])
  @@index([organizationId, provider, model, createdAt])
  @@index([organizationId, correlationId])
  @@map("ai_generation_logs")
}

// OrganizationAiSettings: retention and rate limit overrides
model OrganizationAiSettings {
  id               String   @id @default(cuid())
  organizationId   String   @unique
  retentionDays    Int      @default(30)
  perMinuteLimit   Int? // Nullable; override env
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("organization_ai_settings")
}

// OrganizationIntegration: external service integrations (Reddit, Notion)
model OrganizationIntegration {
  id                    String    @id @default(cuid())
  organizationId        String
  provider              String    @db.VarChar(20) // "reddit" | "notion"
  connectionType        String    @db.VarChar(20) @default("public") // "public" | "internal"
  status                String    @db.VarChar(20) @default("connected") // "connected" | "disconnected" | "error"
  accountId             String?   @db.VarChar(255) // Reddit user id; Notion workspace/bot id
  accountName           String?   @db.VarChar(255) // Reddit username; Notion workspace name
  workspaceId           String?   @db.VarChar(255) // Notion workspace ID (optional)
  encryptedAccessToken  String    @db.Text // AES-256-GCM encrypted
  encryptedRefreshToken String?   @db.Text // AES-256-GCM encrypted, Reddit only
  tokenType             String?   @db.VarChar(50) // e.g., "bearer"
  expiresAt             DateTime?
  scope                 String?   @db.Text
  createdByUserId       String
  updatedByUserId       String
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdBy    User         @relation("IntegrationCreatedBy", fields: [createdByUserId], references: [id], onDelete: Restrict)
  updatedBy    User         @relation("IntegrationUpdatedBy", fields: [updatedByUserId], references: [id], onDelete: Restrict)

  @@unique([organizationId, provider])
  @@index([organizationId, provider])
  @@index([organizationId, updatedAt])
  @@map("organization_integrations")
}

// IntegrationAuthState: temporary OAuth state storage (PKCE)
model IntegrationAuthState {
  id             String   @id @default(cuid())
  state          String   @db.VarChar(255)
  provider       String   @db.VarChar(20)
  organizationId String   @db.VarChar(255)
  userId         String   @db.VarChar(255)
  codeVerifier   String?  @db.VarChar(255) // PKCE code verifier
  expiresAt      DateTime
  createdAt      DateTime @default(now())

  @@index([state, provider])
  @@map("integration_auth_states")
}

// IntegrationCallLog: API call usage logs
model IntegrationCallLog {
  id                 String   @id @default(cuid())
  organizationId     String   @db.VarChar(255)
  userId             String   @db.VarChar(255)
  provider           String   @db.VarChar(20)
  endpoint           String   @db.VarChar(500)
  method             String   @db.VarChar(10)
  status             String   @db.VarChar(20) // "ok" | "error"
  httpStatus         Int?
  latencyMs          Int
  correlationId      String   @db.VarChar(100)
  requestTruncated   String   @db.Text
  responseTruncated  String   @db.Text
  errorCode          String?  @db.VarChar(100)
  errorMessage       String?  @db.Text
  createdAt          DateTime @default(now())

  @@index([organizationId, createdAt])
  @@index([organizationId, provider, createdAt])
  @@index([organizationId, correlationId])
  @@map("integration_call_logs")
}

// ============================================================================
// Sololedger Models & Enums
// ============================================================================

// Sololedger enums
enum TransactionType {
  INCOME
  EXPENSE
}

enum TransactionStatus {
  DRAFT
  POSTED
}

enum CategoryType {
  INCOME
  EXPENSE
}

enum DateFormat {
  DD_MM_YYYY
  MM_DD_YYYY
  YYYY_MM_DD
}

enum DecimalSeparator {
  DOT
  COMMA
}

enum ThousandsSeparator {
  COMMA
  DOT
  SPACE
  NONE
}

// OrganizationSettings: business details and financial configuration
model OrganizationSettings {
  id                     String             @id @default(cuid())
  organizationId         String             @unique
  businessType           String             @db.VarChar(100) // "Freelance", "Consulting", "Agency", "SaaS", "Other"
  businessTypeOther      String?            @db.VarChar(255)
  address                String?            @db.Text
  phone                  String?            @db.VarChar(50)
  email                  String?            @db.VarChar(255)
  taxId                  String?            @db.VarChar(100)
  baseCurrency           String             @db.VarChar(3) // ISO 4217
  fiscalYearStartMonth   Int                @default(1) // 1-12
  dateFormat             DateFormat         @default(YYYY_MM_DD)
  decimalSeparator       DecimalSeparator   @default(DOT)
  thousandsSeparator     ThousandsSeparator @default(COMMA)
  isOnboardingComplete   Boolean            @default(false)
  softDeletedAt          DateTime?
  softClosedBefore       DateTime?          // Transactions before this date are in soft-closed period
  isTaxRegistered        Boolean?
  defaultTaxRate         Decimal?           @db.Decimal(5, 2)
  createdAt              DateTime           @default(now())
  updatedAt              DateTime           @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@map("organization_settings")
}

// Account: where money lives (bank, cash, payment services)
model Account {
  id             String   @id @default(cuid())
  organizationId String
  name           String   @db.VarChar(255)
  description    String?  @db.Text
  isDefault      Boolean  @default(false)
  active         Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  transactions Transaction[]

  @@index([organizationId])
  @@index([organizationId, active])
  @@map("accounts")
}

// Category: income/expense classification with hierarchy
model Category {
  id            String       @id @default(cuid())
  organizationId String
  parentId      String?
  name          String       @db.VarChar(255)
  type          CategoryType
  color         String?      @db.VarChar(50)
  icon          String?      @db.VarChar(50)
  sortOrder     Int          @default(0)
  includeInPnL  Boolean      @default(true)
  active        Boolean      @default(true)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  organization Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  parent       Category?     @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children     Category[]    @relation("CategoryHierarchy")
  transactions Transaction[]

  @@index([organizationId])
  @@index([organizationId, type, active])
  @@index([organizationId, type, parentId, sortOrder])
  @@index([parentId])
  @@map("categories")
}

// Vendor: business contacts for expense transactions
model Vendor {
  id             String        @id @default(cuid())
  organizationId String
  name           String        @db.VarChar(255)
  nameLower      String        @db.VarChar(255) // Lowercase version for case-insensitive uniqueness
  email          String?       @db.VarChar(255)
  phone          String?       @db.VarChar(50)
  notes          String?       @db.Text
  active         Boolean       @default(true)
  mergedIntoId   String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  mergedInto     Vendor?       @relation("VendorMerge", fields: [mergedIntoId], references: [id], onDelete: SetNull)
  mergedVendors  Vendor[]      @relation("VendorMerge")
  transactions   Transaction[]

  @@unique([organizationId, nameLower]) // Enforce case-insensitive unique vendor names per org
  @@index([organizationId, active])
  @@map("vendors")
}

// Client: business contacts for income transactions
model Client {
  id             String        @id @default(cuid())
  organizationId String
  name           String        @db.VarChar(255)
  nameLower      String        @db.VarChar(255) // Lowercase version for case-insensitive uniqueness
  email          String?       @db.VarChar(255)
  phone          String?       @db.VarChar(50)
  notes          String?       @db.Text
  active         Boolean       @default(true)
  mergedIntoId   String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  mergedInto     Client?       @relation("ClientMerge", fields: [mergedIntoId], references: [id], onDelete: SetNull)
  mergedClients  Client[]      @relation("ClientMerge")
  transactions   Transaction[]

  @@unique([organizationId, nameLower]) // Enforce case-insensitive unique client names per org
  @@index([organizationId, active])
  @@map("clients")
}

// Transaction: income or expense entry with dual-currency support
model Transaction {
  id                   String            @id @default(cuid())
  organizationId       String
  accountId            String
  categoryId           String
  userId               String
  type                 TransactionType
  status               TransactionStatus @default(POSTED)

  // Dual-currency model (current)
  amountBase           Decimal           @db.Decimal(18, 2) // Canonical base amount
  currencyBase         String?           @db.VarChar(3)     // Base currency (ISO 4217)
  amountSecondary      Decimal?          @db.Decimal(18, 2) // Optional secondary/original amount
  currencySecondary    String?           @db.VarChar(3)     // Optional secondary/original currency

  // Legacy fields (deprecated; kept for migration and audit only)
  amountOriginal       Decimal           @db.Decimal(18, 2)
  currencyOriginal     String            @db.VarChar(3)
  exchangeRateToBase   Decimal           @db.Decimal(18, 8)

  date                 DateTime
  description          String            @db.Text
  vendorId             String?
  vendorName           String?           @db.VarChar(255)
  clientId             String?
  clientName           String?           @db.VarChar(255)
  tags                 String?           @db.Text
  notes                String?           @db.Text
  deletedAt            DateTime?
  createdAt            DateTime          @default(now())
  updatedAt            DateTime          @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  account      Account       @relation(fields: [accountId], references: [id], onDelete: Restrict)
  category     Category      @relation(fields: [categoryId], references: [id], onDelete: Restrict)
  vendor       Vendor?       @relation(fields: [vendorId], references: [id], onDelete: SetNull)
  client       Client?       @relation(fields: [clientId], references: [id], onDelete: SetNull)
  user         User          @relation("TransactionCreator", fields: [userId], references: [id], onDelete: Restrict)

  @@index([organizationId])
  @@index([organizationId, date])
  @@index([organizationId, type, status])
  @@index([organizationId, categoryId, status, date])
  @@index([organizationId, vendorId, status, date])
  @@index([organizationId, clientId, status, date])
  @@index([organizationId, accountId, status, date])
  @@index([organizationId, deletedAt])
  @@index([organizationId, currencySecondary]) // For currency filters
  @@index([accountId])
  @@index([categoryId])
  @@index([vendorId])
  @@index([clientId])
  @@index([userId])
  @@map("transactions")
}
